# GameLauncher 設計書

## 1. 概要

GameLauncherは、Windows向けのアプリケーション/ゲームランチャーです。
PCにインストールされたアプリケーションを自動検出・管理し、簡単に起動できるようにします。

### 1.1 技術スタック

- **フレームワーク**: Qt 6.10.1
- **言語**: C++
- **プラットフォーム**: Windows (Win32 API使用)
- **ビルドシステム**: qmake

### 1.2 主要機能

- アプリケーションの自動検出（Steam、スタートメニュー、デスクトップ等）
- アイコンの自動抽出・キャッシュ
- アプリケーションの起動・起動回数の記録
- カテゴリによる分類
- 除外リスト機能
- ページネーション付きリスト表示

---

## 2. アーキテクチャ

### 2.1 クラス構成図

```
MainWindow
    ├── AppManager (アプリケーション管理)
    │   └── CategoryManager (カテゴリ管理)
    ├── AppLauncher (アプリケーション起動)
    ├── IconExtractor (アイコン抽出)
    ├── AppListModel (テーブルモデル)
    └── AppIconDelegate (アイコン描画デリゲート)

AppDiscoveryDialog
    ├── AppDiscovery (アプリケーション検出)
    └── AppManager (参照)

AddAppDialog
    ├── IconExtractor
    └── CategoryManager (参照)
```

---

## 3. データ構造

### 3.1 AppInfo（アプリケーション情報）

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| id | QString | 一意識別子（UUID） |
| name | QString | アプリケーション名 |
| path | QString | 実行ファイルパス |
| iconPath | QString | アイコンファイルパス（PNG） |
| lastLaunch | QDateTime | 最終起動時刻 |
| launchCount | int | 起動回数 |
| description | QString | 説明（任意） |
| createdAt | QDateTime | 登録日時 |
| category | QString | カテゴリ名 |

### 3.2 CategoryInfo（カテゴリ情報）

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| name | QString | カテゴリ名 |
| color | QColor | 表示色 |
| icon | QString | アイコンパス |

### 3.3 ScanOptions（スキャンオプション）

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| includePaths | QStringList | スキャン対象パス |
| excludePaths | QStringList | 除外パス |
| excludePatterns | QStringList | 除外パターン（ワイルドカード） |
| maxDepth | int | 最大検索深度（デフォルト: 5） |
| scanDesktop | bool | デスクトップをスキャン |
| scanStartMenu | bool | スタートメニューをスキャン |
| scanProgramFiles | bool | Program Filesをスキャン |
| scanSteam | bool | Steamをスキャン |

---

## 4. コンポーネント詳細

### 4.1 MainWindow（メインウィンドウ）

**責務**: メインUIの管理、各コンポーネントの統括

**主要機能**:
- リストビュー表示（QTableView）
- ページネーション（動的行数計算）
- 複数選択・一括削除
- 列幅の保存・復元
- アイコンキャッシュの事前構築

**UI設定**:
- アイコンサイズ: 48x48px
- 行高さ: 56px
- 選択モード: ExtendedSelection（複数選択可能）

**列構成**:
| 列 | 内容 |
|----|------|
| 0 | アイコン + アプリ名 |
| 1 | パス |
| 2 | 最終起動日時 |
| 3 | 起動回数 |

### 4.2 AppManager（アプリケーション管理）

**責務**: アプリケーションデータの管理・永続化

**データファイル**: `apps.json`（アプリケーションディレクトリ内）

**主要メソッド**:
- `addApp()` / `addApps()`: アプリ追加（単体/一括）
- `removeApp()`: アプリ削除
- `updateApp()`: アプリ更新
- `findApp()`: アプリ検索
- `loadApps()` / `saveApps()`: データ読み込み/保存
- `searchApps()`: キーワード検索
- `getAppsByCategory()`: カテゴリフィルタ

### 4.3 AppLauncher（アプリケーション起動）

**責務**: アプリケーションの起動・プロセス管理

**主要機能**:
- QProcessによる非同期起動
- 作業ディレクトリの自動設定
- 起動回数・最終起動時刻の更新
- 複数プロセスの同時管理

**シグナル**:
- `launched(appId)`: 起動成功
- `finished(appId, exitCode)`: 終了
- `errorOccurred(appId, error)`: エラー発生

### 4.4 IconExtractor（アイコン抽出）

**責務**: 実行ファイルからのアイコン抽出・保存

**抽出方法**（優先順）:
1. Win32 API（ExtractIconEx）
2. Win32 API（ExtractIcon）
3. Win32 API（SHGetFileInfo）
4. QFileIconProvider
5. デフォルトアイコン

**キャッシュディレクトリ**: `%LOCALAPPDATA%/GameLauncher/cache/icons/`

**保存形式**: PNG（32x32px）

### 4.5 AppDiscovery（アプリケーション検出）

**責務**: システムからのアプリケーション自動検出

**検出ソース**:
- デスクトップショートカット
- スタートメニュー
- Program Files
- Steamライブラリ
- レジストリ（アンインストール情報）

**デフォルト除外パターン**:
```
*unins*.exe, *uninst*.exe, *uninstall*.exe
*setup*.exe, *install*.exe, *update*.exe
*patch*.exe, *config*.exe, *setting*.exe
*launcher*.exe, *crash*.exe, *report*.exe
```

### 4.6 AppListModel（テーブルモデル）

**責務**: QTableView用のデータモデル

**主要機能**:
- ページネーション対応
- アイコンキャッシュ連携
- 表示用フォーマット関数

**カスタムロール**:
- `AppIdRole`: アプリID
- `AppPathRole`: 実行パス
- `IconPathRole`: アイコンパス

### 4.7 AppIconDelegate（アイコンデリゲート）

**責務**: テーブルセルのカスタム描画

**主要機能**:
- QImageによる軽量描画（QPixmap/QIcon非使用）
- 画像キャッシュ
- アイコン + テキストの描画

**サイズ**:
- アイコン: 48x48px
- 行高さ: 56px

---

## 5. ダイアログ

### 5.1 AddAppDialog（アプリ追加ダイアログ）

**機能**:
- 実行ファイル選択
- アプリ名編集
- アイコン抽出/手動選択
- カテゴリ選択
- 説明入力

**モード**:
- 新規追加モード
- 編集モード

### 5.2 AppDiscoveryDialog（アプリ検出ダイアログ）

**機能**:
- スキャンパス管理
- スキャン実行/キャンセル
- 検出結果表示（チェックボックス付き）
- 選択アプリの一括登録
- 除外リスト管理
- 除外パターン追加

**列構成**:
| 列 | 内容 |
|----|------|
| 0 | チェックボックス |
| 1 | アイコン |
| 2 | アプリ名 |
| 3 | パス |
| 4 | カテゴリ |
| 5 | ファイルサイズ |

---

## 6. データ永続化

### 6.1 アプリケーションデータ

**ファイル**: `apps.json`

**形式**:
```json
{
  "apps": [
    {
      "id": "uuid-string",
      "name": "アプリ名",
      "path": "C:/path/to/app.exe",
      "iconPath": "C:/path/to/icon.png",
      "lastLaunch": "2026-01-31T12:00:00",
      "launchCount": 10,
      "description": "説明",
      "createdAt": "2026-01-01T00:00:00",
      "category": "ゲーム"
    }
  ],
  "categories": {
    "ゲーム": { "color": "#FF0000", "icon": "" }
  }
}
```

### 6.2 除外リスト

**ファイル**: `exclude_list.txt`

**形式**: 1行1パス
```
C:\Program Files\Example\uninstall.exe
C:\Program Files\Example\setup.exe
```

### 6.3 設定（QSettings）

**保存先**: Windowsレジストリ

**保存項目**:
- 列幅設定（listTableView/columnWidths）

---

## 7. パフォーマンス最適化

### 7.1 アイコンキャッシュ

- **メモリキャッシュ**: QMap<QString, QPixmap>による32pxアイコンキャッシュ
- **デリゲートキャッシュ**: QMap<QString, QImage>による48pxアイコンキャッシュ
- **ディスクキャッシュ**: PNGファイルとして保存

### 7.2 ページネーション

- 動的行数計算（ウィンドウサイズに応じて自動調整）
- layoutChanged使用（beginResetModelより軽量）
- スクロールバー非表示（ページ切り替えで代替）

### 7.3 テーブルビュー設定

- ソート無効
- 交互背景色無効
- グリッド非表示
- 固定行高さ

---

## 8. 選択機能

### 8.1 複数選択

- **選択モード**: ExtendedSelection
- **選択管理**: QSet<QString> m_selectedAppIds
- **ページ跨ぎ対応**: 選択状態はappIdベースで保持

### 8.2 削除機能

- 選択アプリ一覧表示ダイアログ
- 「削除」ボタン
- 「除外リストに追加して削除」ボタン
- 「キャンセル」ボタン

---

## 9. ファイル構成

```
GameLauncher/
├── main.cpp                 # エントリーポイント
├── mainwindow.cpp/h/ui      # メインウィンドウ
├── appinfo.cpp/h            # アプリ情報構造体
├── appmanager.cpp/h         # アプリ管理
├── applauncher.cpp/h        # アプリ起動
├── appdiscovery.cpp/h       # アプリ検出
├── appdiscoverydialog.cpp/h/ui  # 検出ダイアログ
├── addappdialog.cpp/h/ui    # 追加ダイアログ
├── iconextractor.cpp/h      # アイコン抽出
├── applistmodel.cpp/h       # テーブルモデル
├── appicondelegate.cpp/h    # 描画デリゲート
├── categorymanager.cpp/h    # カテゴリ管理
├── GameLauncher.pro         # プロジェクトファイル
└── docs/                    # ドキュメント
```

---

## 10. 今後の拡張予定

- グリッドビュー表示（現在無効化中）
- 設定ダイアログ
- カテゴリ管理UI
- ソート機能
- フィルタ機能の強化
- インポート/エクスポート機能

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-01-31 | 1.0 | 初版作成 |
